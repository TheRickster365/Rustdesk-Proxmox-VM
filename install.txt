#Use Proxmox helper scripts to install Debian12 VM
#https://community-scripts.github.io/ProxmoxVE/scripts?id=debian-vm
#
#In Debian12 VM
#
apt update
apt upgrade
apt install ufw
apt install wget
apt install mc
apt install ccze

apt install qemu-guest-agent
systemctl enable qemu-guest-agent
systemctl start qemu-guest-agent
systemctl status qemu-guest-agent

hostnamectl set-hostname rustdesk
hostnamectl 

#Set Rustdesk firewall rules
#
ufw allow 21114:21119/tcp
ufw allow 21116/udp
ufw enable

#Get Rustdesk deb install files
wget https://github.com/rustdesk/rustdesk-server/releases/download/1.1.12/rustdesk-server-hbbr_1.1.12_amd64.deb
wget https://github.com/rustdesk/rustdesk-server/releases/download/1.1.12/rustdesk-server-hbbs_1.1.12_amd64.deb

#Install Rustdesk
/usr/lib/mc/extfs.d/deb run /root/rustdesk-server-hbbr_1.1.12_amd64.deb INSTALL
/usr/lib/mc/extfs.d/deb run /root/rustdesk-server-hbbs_1.1.12_amd64.deb INSTALL

#dpkg -i rustdesk-server-hbbr_1.1.12_amd64.deb
#dpkg -i rustdesk-server-hbbs_1.1.12_amd64.deb

#Enable and Start Rustdesk services
systemctl enable rustdesk-hbbr
systemctl start rustdesk-hbbr
systemctl enable rustdesk-hbbs
systemctl start rustdesk-hbbs

#Show Autogenerated Key
cat /var/lib/rustdesk-server/id_ed25519.pub 

#Create config dir and file under /etc
mkdir /etc/rustdesk
echo -n "RELAY=" > /etc/rustdesk/rustdesk.conf
hostname -I >> /etc/rustdesk/rustdesk.conf
echo -n "KEY=" >> /etc/rustdesk/rustdesk.conf
cat /var/lib/rustdesk-server/id_ed25519.pub >>/etc/rustdesk/rustdesk.conf
echo "" >> /etc/rustdesk/rustdesk.conf
cat /etc/rustdesk/rustdesk.conf

#Modify systemd service files to use parameters from conf file
sed -i 's|ExecStart=/usr/bin/hbbs|EnvironmentFile=/etc/rustdesk/rustdesk.conf\nExecStart=/usr/bin/hbbs -r $RELAY -k $KEY|g' /lib/systemd/system/rustdesk-hbbs.service

sed -i 's|ExecStart=/usr/bin/hbbr|EnvironmentFile=/etc/rustdesk/rustdesk.conf\nExecStart=/usr/bin/hbbr -k $KEY|g' /lib/systemd/system/rustdesk-hbbr.service

#restart services
systemctl restart rustdesk-hbbr
systemctl restart rustdesk-hbbs


#Get and install webmin
curl -o webmin-setup-repo.sh https://raw.githubusercontent.com/webmin/webmin/master/webmin-setup-repo.sh
sh webmin-setup-repo.sh
apt install webmin
ufw allow 10000/tcp

apt install sqlite3
sqlite3 /var/lib/rustdesk-server/db_v2.sqlite3 ".mode html" ".headers ON" "select * from peer;" ".exit"

apt install apache2
systemctl start apache2
systemctl enable apache2
ufw allow 80/tcp
ufw allow 443/tcp

apt install php
#apt install php-{common,mysql,xml,xmlrpc,curl,gd,imagick,cli,dev,imap,mbstring,opcache,soap,zip,intl}
apt install php-{common,xml,xmlrpc,curl,gd,imagick,cli,dev,mbstring,opcache,soap,zip,intl,sqlite3}
apt install php-sqlite3

chown root:www-data /var/lib/rustdesk-server/db_v2*
chmod 664 /var/lib/rustdesk-server/db_v2*
